---
title: "Visualización de datos geográficos con leaflet"
author: "Kimberley Isabel Orozco Cornejo"
date: "2023-06-27"
output:
  html_document: default
always_allow_html: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(leaflet)
library(readr)
library(dplyr)
library(janitor)
library(stringr)
```

# Introducción

Hoy aprenderemos sobre el mundo de la visualización de datos geográficos utilizando 
la biblioteca 'leaflet' en R. Leaflet es una de las bibliotecas más populares para 
crear mapas interactivos directamente desde R.

Esta biblioteca es una biblioteca de código abierto, podemos utilizarla para crear mapas increíblemente versátiles y personalizables directamente desde nuestro entorno de trabajo de R. Con leaflet, podemos trazar nuestros datos en mapas con características como marcadores, y popups. Además, Leaflet es compatible con una amplia variedad de capas de mapa, lo que nos permite elegir la apariencia exacta que deseamos para nuestro mapa.

Para crear un mapa con leaflet, el primer paso es llamar a la función leaflet
y pasarle seguidamente la función addTiles, como se ve a continuación:

```{r}
mapa <- leaflet() |> 
  addTiles()  # Añade OpenStreetMap map por defecto

mapa
```

Observe que se abre el Viewer en su RStudio con un mapa, en el que puede hacer Zoom, mover
el mapa y ver con detalle las regiones que desee.

Ahora bien, este mapa así como está no es muy util que digamos, ya que no nos brinda información adicional. Adicionalmente, no siempre queremos ver todo el mapa, en algunas ocasiones queremos enfocarnos en ciertas regiones.

Para delimitar la región del mapa que queremos ver, podemos usar varias funciones,
por ejemplo fitBounds o setView.

### fitBounds
La función fitBounds ajusta la vista al rectángulo con coordenadas [lng1, lat1] – [lng2, lat2].

Acá es importante tener en cuenta que la función fitBounds recibe los números en 
grados decimales. Si las coordenadas no están en grados decimales (es decir, si indican
Norte, Sur, Este u Oeste), deberemos colocarlos son su signo correspondiente, de 
acuerdo a la siguiente convención: 

Norte : +
Sur : -
Este : +
Oeste : -

Por ejemplo, suponga que queremos setear la vista para obtener el mapa que se encuentra
entre la longitud 5° Oeste y 10° Este, y la latitud 40° Norte y 50° Norte.

En este caso, tendríamos:
Longitud1 : -5
Longitud2: 10
Latitud1: 40
Latitud2: 50

```{r}
mapa1 <- leaflet() |> 
  addTiles() |> 
  fitBounds(-5, 40, 10, 50) # longitud1, latitud1, longitud2, latitud2

mapa1
```

Práctica

Costa Rica se encuentra en el Istmo Centroamericano, dentro de las coordenadas 
geográficas 8 ° y 11 ° de latitud norte y 82 ° y 85 °, de longitud Oeste.

Cree una vista con el mapa de Costa Rica.

```{r}
mapacr <- leaflet() |> 
  addTiles() |> 
  fitBounds(-83, 9, -85, 10)

mapacr
```

### setView

Con la función setView, podemos setear la vista indicando solamente el punto
central del mapa y su nivel de Zoom. Volviendo al ejemplo de Costa Rica, si buscamos
sus coordenadas en https://www.geodatos.net/coordenadas/costa-rica, nos indica
un valor de 9.748917, -83.753428 (latitud, longitud).

Podemos crer entonces nuestro mapa de la siguiente manera:

```{r}
mapa2 <- leaflet() |> 
  addTiles() |> 
  setView(-83.753428, 9.748917, zoom = 7,5) #longitud, latitud

mapa2
```

El nivel de Zoom necesario no es inmediatamente obvio en la mayoría de los
casos, por lo que conviene experimentar un poco hasta obtener una vista que nos
sirva.

#### Ejercicio

Experimente cambiando varios valores de Zoom en el código anterior.

Observe que con el zoom obtenemos un mapa más delimitado, y podemos hacer zooom 
tanto como queramos. Si queremos delimitar las opciones de Zoom, podemos indicarlo 
como argumento dentro de la función leaflet, de la siguiente manera:

```{r}
mapa3 <- leaflet(options = leafletOptions(minZoom = 5, maxZoom = 15)) |> 
  addTiles() |> 
   setView(-83.753428, 9.748917, zoom = 5)
  
mapa3
```

Es importante notar que delimitar el mapa con las funciones setView o fitBounds no
es estrictamente necesario, sino lo indicamos leaflet se encargará por nosotros
de centrar más o menos el mapa. 

## Añadir marcadores en el mapa

Ahora, suponga que queremos marcar en el mapa el lugar donde nació el lenguage R
(En la Universidad de Auckland, Nueva Zelanda). Para marcar este punto, necesitamos
añadir al widget del mapa la función addMarkers() usando como argumentos la longitud (lng)
y latitud (lat) en grados decimales. En nuestro caso estos números son 174.768 y -36.852
respectivamente.

```{r}
mapa4 <- leaflet() |> 
  addTiles() |> # Anade mapa mundial por defecto "OpenStreetMap"
  addMarkers(lng = 174.768, lat = -36.852, popup = "Donde nació R")
  
mapa4
```

Otra manera es usando por ejemplo addCircles, como se ve en el siguiente ejemplo:

```{r}
mapa5 <- leaflet() |> 
  addTiles() |> # Anade mapa mundial por defecto "OpenStreetMap"
  addCircles(lng = 174.768, lat = -36.852, radius = 90, color = "#06F7DF", popup = "Donde nació R")
  
mapa5
```

Observe que el popup nos permite indicar una leyenda para el punto definido!

### Práctica

Cree una vista del mapa de Costa Rica (que se visualice entero) y añada con addMarkers
o addCircles las coordenadas de Heredia, Puntarenas y Limón. Las coordenadas debe 
buscarlas en google, geodatos.net es una buena opción.

```{r}
mapacr <- leaflet() |> 
  addTiles() |> 
  addMarkers(lng = -84.11651, lat = 10.00236, popup = "Heredia") |> 
  addMarkers(lng = -84.83836, lat = 9.97625, popup = "Puntarenas") |> 
  addMarkers(lng = -83.03596, lat = 9.99074, popup = "Limon")

mapacr
```


### Indicar múltiples puntos en el mapa

La forma anterior de añadir "Markers" no es la más efectiva. 
Haremos ahora uso de un dataset con información geográfica de las coordenadas
de distintos países.

```{r}
datos_pais <- read_csv("datos/countries.csv")
```

Eliminemos las columnas Importance y Altitude que no necesitaremos, y usemos la librería
janitor para "limpiar" los nombres de las columnas:

```{r}
datos_pais <- datos_pais |> 
  select(-Importance, -Altitude) |> 
  clean_names()
```

Suponga que queremos representar en el mapa aquellos países que se empiezan con 
"A".

```{r}
paises_con_a <- datos_pais |> 
  filter(str_starts(country, "A"))
```

Ahora, añadamos las capas que conocemos

```{r}
mi_mapa <- paises_con_a |> # conjunto de datos
  leaflet() |> # crea mapa vacío
  addTiles() |> #añade capa mapa por defecto
  addMarkers(lng = ~longitude, lat = ~latitude, popup = ~country) # añade marcadores usando las columnas indicadas del dataframe

mi_mapa
```

Muy bien! Hemos aprendido las funcionalidades básicas de la librería leaflet, que nos
brinda una herramienta relativamente sencilla pero muy poderosa para la representación 
de información en mapas. La librería leaflet tiene muchas otras funcionalidades,
puede explorarlas más profundamente en el siguiente enlace https://rstudio.github.io/leaflet/map_widget.html.